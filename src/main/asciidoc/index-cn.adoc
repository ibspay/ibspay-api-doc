= API Document for IBS Payment Gateway
v0.0, 2018-02-11
:doctype: article
:description: IBS Payment Gateway API
:keywords: IBS Payment Gateway,API
:sectlinks:
:sectanchors:
:sectnums:
:source-highlighter: coderay
:icons: font
:toclevels: 4
:encoding: utf-8
:imagesdir: images
:toc: left
:toc-title: 目录
:experimental:
:font: Microsoft YaHei

== 文档说明

++++
IBS Payment Gateway文档说明
++++

=== 版本说明

* 2017-09-05 +
Version 1.0.0


=== 全局规划

* 服务器地址: \https://api.payingcloud.cn
* 请求方式kbd:[*POST*]：/open
* 数据传输格式: json
* 异步通知接口执行结果。

=== 签名规则

用户需在HTTP请求中增加 Header来包含签名信息，表明这个消息已被授权。Header包括
 kbd:[*HEADER_KEY*] AccessKey、kbd:[*HEADER_SIGN*] 请求时生成、kbd:[*HEADER_ACTION*] 请求接口类别(具体值见<<接口类型枚举值>>)、kbd:[*HEADER_NONCE*] 签名生成时系统时间。

.HEADER_SIGN生成方法
[source,Java]
----
 DigestUtils.md5Hex((key +              //<1>
                     action +           //<2>
                     nonce +            //<3>
                     body +             //<4>
                     secret).getBytes("UTF-8"));   //<5>
----
<1> 使用md5Hex进行签名,kbd:[*key*] 为AccessKey，由商户注册IBSPay时控制台生成。
<2> kbd:[*action*] 表示请求哪个接口
<3> kbd:[*nonce*] 签名生成时系统时间 kbd:[*System.currentTimeMillis()*] 。
<4> kbd:[*body*] 表示请求体的json完整json内容
<5> kbd:[*secret*] 为AccessSecret，由商户注册IBSPay时控制台生成。

.备注
____
HEADER_SIGN生成时拼接的四个字符串与headers的四个值对应。
____

=== 验签规则
为防止黑客伪造交易结果给商户造成损失，IBSPay对所有发给商户的交易结果异步通知都进行了MD5签名，并将相关参数放在Http请求头中包括 kbd:[*x-ibspay-sign*]、kbd:[*x-ibspay-nonce*]、kbd:[*x-ibspay-key*], x-ibspay-sign的值生成方法和签名中的HEADER_SIGN一致。开发者可根据header及密钥信息对其进行验证： +

.代码示例
[source,Java]
----
// 从异步通知请求头中获取签名
String sign = request.getHeader("sign");
// 获取x-ibspay-nonce
String nonce = request.getHeader("x-ibspay-nonce");
// 获取异步通知请求体
String content = ...
// 服务端生成sign
String signLocal = DigestUtils.md5Hex((key + action + nonce + body + secret).getBytes(StandardCharsets.UTF_8));
// 验证
if (!Objects.equals(sign, signLocal)) {
            throw new UnauthorizedException("Invalid sign");
        }
 return "success";
----

== API接口

=== 付款接口

==== 接口概述
支付流程如下图所示: +

image::payment-flowchart.jpg[scaledwidth=100%,align="center"]

==== 请求参数

[cols=".^4,.^2,.^4,.^4,.^4"]
|===
| 变量名 | 必填 | 类型 | 示例值 | 描述

|appPaymentId
|是
|String
|3F2504E0
|用户在商户应用的支付单号

| paymentMethod
| 是
| enum
| ALIPAY_SCAN
| 支付方式详见<<支付方式枚举值>>

| subject
| 是
| String(128)
| iPhone7-32G
| 商品详情

| amount
| 是
| Double
| 0.00
| 订单总金额

| bankCard
| 否
| BankCard
| ...
| 银行卡信息详见 <<银行卡类型>>支付方式为BAND_CARD时必填

| payer
| 是
| Payer
| ...
| 付款人信息 详见<<付款人>>

| receiver
| 是
| Receiver
| ...
| 收货人信息 详见<<收货人类型>>

| orders
| 是
| list
| ...
| 订单列表，每个订单只能是相同的商品类型。订单参见<<订单类型>>

| notifyUrl
| 是
| String(100)
| \https://api.payingcloud.cn/callback
| 异步通知地址，支付成功后返回支付结果地址。

|===

==== 同步返回参数

[col=5*]
|===
|变量名 |必填 |类型 |示例值 |描述

| paymentId
| 是
| String
| 3F2504E0-4F89-11D3-9A0C-0305E82C3301
| 支付订单号

| codeUrl
| 否
| String
| \https://example.org
| 扫码支付时返回必填值

|===

==== 异步通知参数
注：银行卡支付时此发起支付没有异步通知，确认支付后通知。
[col=5*]
|===
|变量名 |必填 |类型 |示例值 |描述

| merchantId
| 是
| long
| 1L
| 商户账号

| appId
| 是
| long
| 1L
| 商户应用账号

| paymentId
| 是
| String
| 3F2504E0-4F89-11D3-9A0C-0305E82C3301
| 支付订单号

| paymentMethod
| 是
| String
| ALIPAY_SCAN
| 渠道类型

| subject
| 是
| String(128)
| iPhone7-32G
| 商品详情

| amount
| 是
| BigDecimal
| 1.00
| 订单金额

| notifyUrl
| 是
| String
| https://www.ibspay.com/paymentNotify
| 支付通知地址

| status
| 是
| 枚举值
| SUCCESS
| 支付订单状态

|===

=== 确认支付接口
使用银行卡支付时，调用付款接口后发送验证码，用户输入验证码后调用确认支付。（仅用于银行卡支付）

==== 请求参数

|===
|变量名 |必填 |类型 |示例值 |描述

|appPaymentId
|是
|String
|3F2504E0
|用户在商户应用的支付单号

|paymentId
|是
|String
|3F2504E0-4F89-11D3-9A0C-0305E82C3301
|ibspay返回的支付单号

|code
|是
|String
|090987
|短信验证码

|===
==== 同步返回参数
|===
|变量名 |必填 |类型 |示例值 |描述

|paymentId
|是
|String
|3F2504E0-4F89-11D3-9A0C-0305E82C3301
|ibspay返回的支付单号

|===

==== 异步通知参数

[col=5*]
|===
|变量名 |必填 |类型 |示例值 |描述

| merchantId
| 是
| long
| 1L
| 商户账号

| appId
| 是
| long
| 1L
| 商户应用账号

| paymentId
| 是
| String
| 3F2504E0-4F89-11D3-9A0C-0305E82C3301
| 支付订单号

| paymentMethod
| 是
| String
| ALIPAY_SCAN
| 渠道类型

| subject
| 是
| String(128)
| iPhone7-32G
| 商品详情

| amount
| 是
| BigDecimal
| 1.00
| 订单金额

| notifyUrl
| 是
| String
| https://www.ibspay.com/paymentNotify
| 支付通知地址

| status
| 是
| 枚举值
| SUCCESS
| 支付订单状态

|===

=== 退款接口

退款流程图如下 +

image::refund-flowchart.jpg[scaledwidth=100%,align="center"]

==== 请求参数

|===
|变量名 |必填 |类型 |示例值 |描述

|appPaymentId
|是
|String
|3F2504E0
|用户在商户应用的支付单号

|appRefundId
|是
|String
|3F2504E0
|用户在商户应用的退款单号

|paymentId
|是
|String
|3F2504E0-4F89-11D3-9A0C-0305E82C3301
|ibspay返回的支付单号

| subject
| 是
| String(128)
| iPhone7-32G
| 商品详情

| notifyUrl
| 是
| String
| https://www.ibspay.com/paymentNotify
| 退款成功异步通知地址
|===

==== 返回结果
|===
|变量名 |必填 |类型 |示例值 |描述

|refundId
|是
|String
|3F2504E0-4F89-11D3-9A0C-0305E82C3301
|退款单号

|===

==== 异步通知参数

|===
|变量名 |必填 |类型 |示例值 |描述

| refundId
| 是
| String
| 3F2504E0-4F89-11D3-9A0C-0305E82C3301
| 退款单号

| merchantId
| 是
| long
| 1L
| 商户账号

| appId
| 是
| long
| 1L
| 商户应用账号

| paymentId
| 是
| String
| 3F2504E0-4F89-11D3-9A0C-0305E82C3301
| 支付时订单号

| paymentMethod
| 是
| String
| ALIPAY_SCAN
| 支付方式

| subject
| 是
| String(128)
| iPhone7-32G
| 商品详情

| amount
| 是
| BigDecimal
| 1.00
| 订单金额

| notifyUrl
| 是
| String
| https://www.ibspay.com/paymentNotify
| 支付通知地址

| status
| 是
| 枚举值
| SUCCESS
| 支付订单状态

|===


=== 订单查询

==== 请求参数
|===
|变量名 |必填 |类型 |示例值 |描述

|appPaymentId
|是
|String
|3F2504E0
|用户在商户应用的支付单号

| paymentId
| 是
| String
| 3F2504E0-4F89-11D3-9A0C-0305E82C3301
| 支付时订单号（由ibspay返回）

|===

==== 返回参数
|===
|变量名 |必填 |类型 |示例值 |描述

| paymentId
| 是
| String
| 3F2504E0-4F89-11D3-9A0C-0305E82C3301
| ibspay返回的支付单号

| status
| 是
| 枚举值
| SUCCESS
| 支付订单状态

|===

=== 退款单查询

==== 请求参数

|===
|变量名 |必填 |类型 |示例值 |描述

|appRefundId
|是
|String
|3F2504E0
|用户在商户应用的退款单号

| refundId
| 是
| String
| 3F2504E0-4F89-11D3-9A0C-0305E82C3301
| ibspay返回的退款单号

|===

==== 返回参数

|===
|变量名 |必填 |类型 |示例值 |描述

| refundId
| 是
| String
| 3F2504E0-4F89-11D3-9A0C-0305E82C3301
| ibspay返回的支付单号

| status
| 是
| 枚举值
| SUCCESS
| 退款订单状态

|===


== 备注

各接口用到的参数类型及枚举值补充。

[[接口类型枚举值]]
=== 接口类型枚举值

[align="center"]
|===

|枚举值 |描述

|INITIATE_PAYMENT
|支付接口

|CONFIRM_PAYMENT
|确认支付接口(只在使用银行卡支付时输入验证码后调用)

|INITIATE_REFUND
|退款接口

|QUERY_PAYMENT
|查询支付接口

|QUERY_REFUND
|查询退款接口

|===

[[支付方式枚举值]]
=== 支付方式枚举值

[align="center"]
|===

|枚举值 |描述

|BAND_CARD
|银行卡

|ALIPAY_SCAN
|支付宝扫码

|ALIPAY_JSAPI
|支付宝公众号

|ALIPAY_APP
|支付宝APP

|WECHAT_SCAN
|微信扫码

|WECHAT_JSAPI
| 微信公众号

|WECHAT_APP
|微信app

|===

[[交易类型枚举值]]
=== 交易类型枚举值

[align="center"]
|===

|枚举值 |描述

|TC01121990
|货物贸易,网络购物（报关）

| TC01122030
|货物贸易,未纳入海关统计的网络购物

|TC02223022
| 留学, 留学及教育相关旅行（一年以上）学费

|TC02223023
| 留学, 留学及教育相关旅行（一年及一年以下）学费

|TC03222024
| 机票, 跨境机票款

|TC03223010
| 机票, 公务及商务旅行机票

|TC03223021
| 机票, 就医及健康相关旅行机票

|TC03223022
| 机票, 留学及教育相关旅行（一年以上）机票

|TC03223023
| 机票, 留学及教育相关旅行（一年以下）机票

|TC03223029
| 机票, 其他私人旅行机票

|TC04223010
| 酒店, 留学及教育相关旅行（一年以下）酒店

|TC04223021
| 酒店,其他私人旅行酒店

|TC04223022
| 酒店,公务及商务旅行酒店

|TC04223023
| 酒店, 就医及健康相关旅行酒店

|TC04223029
| 酒店,留学及教育相关旅行（一年以上）酒店

|TC06223010
| 旅游,公务及商务旅行

|TC06223021
| 旅游,就医及健康相关旅行

|TC06223022
| 旅游,留学及教育相关旅行（一年以上）

|TC06223023
| 旅游,留学及教育相关旅行（一年及一年以下）

|TC06223029
| 旅游,其他私人旅行

|===

[[商品类型枚举值]]
=== 商品类型枚举值

[align="center"]
|===
|枚举值 |描述

| CLOTHING
| 服装

|FOOD,
| 食品

|ELECTRONIC
| 电子产品

|OTHER
| 其他

|===
[[银行卡类]]
=== 银行卡类

注：所填银行卡号的持有人和银行预留手机号应和付款人里的信息的一致。

[align="center"]
|===
|变量 |必填 |类型 |描述

|number
|是
|String
|银行卡号

|validDate
|否
|String
|有效期，若使用信用卡必填

|cvv2
|否
|String
|银行安全码，若使用信用卡必填

|===

[[付款人类型]]
=== 付款人类

[align="center"]
|===
|变量 |必填 |类型 |描述

|name
|是
|String
|付款人姓名

|citizenId
|是
|String
|身份证号

|mobile
|是
|String
|手机号，应与付款方式相应手机号一致

|ip
|是
|String
|终端IP，APP和网页支付提交用户端ip。
|===

[[收货人类型]]
=== 收货人类

[align="center"]
|===

|变量 |必填 |类型 |描述

|name
|是
|String
|收货人姓名

|mobile
|是
|String
|手机号

|address
|是
|String
|收货人地址。
|===

[[订单类型]]
=== 订单类
[align="center"]
|===
|变量 |必填 |类型 |描述

|orderNo
|是
|String
|订单号

|transCode
|是
|enum
|交易代码 参见<<交易类型枚举值>>

|amount
|是
|Double
|总金额

|customs
|是
|Boolean
|是否报关

|invoiceNo
|否
|String
|发票号

|items
|是
|List
|商品列表 参见<<商品类>>

|===

[[商品类]]
=== 商品类

[align="center"]
|===

|变量 |必填 |类型 |描述

|goodsNo
|是
|String
|商品编号

|goodsType;
|是
|enum
|商品类型,详见<<商品类型枚举值>>

|goodsName
|是
|String
|商品名

|quantity
|是
|Integer
|商品数量

|description
|是
|String
|商品描述

|price
|是
|Double
|商品价格

|===





